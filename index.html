<!DOCTYPE html>
<html>
<head>
  <title>DNREC Shellfish Survey Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    #map {
      height: 90vh;
      width: 100%;
    }

    /* Zone list control styling */
    .zone-control {
      background: #fff;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 13px;
      line-height: 1.25;
      max-height: 260px;
      overflow: auto;
      min-width: 210px;
    }

    .zone-control .title {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .zone-control .title .btns {
      display: flex;
      gap: 6px;
    }

    .zone-control .title button {
      border: 1px solid #ddd;
      background: #f7f7f7;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }

    .zone-control .title button:hover {
      background: #eee;
    }

    .zone-control .hint {
      font-size: 12px;
      color: #555;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .zone-control ol {
      margin: 0;
      padding-left: 18px;
    }

    .zone-control li {
      margin: 2px 0;
    }

    .zone-link {
      cursor: pointer;
      text-decoration: underline;
      color: #1f78b4;
      user-select: none;
    }

    .zone-link.active {
      font-weight: 700;
      color: #0b4f8a;
    }

    /* Collapsed state */
    .zone-control.collapsed .hint,
    .zone-control.collapsed ol {
      display: none;
    }

    /* Mobile tweaks */
    @media (max-width: 600px) {
      .zone-control {
        min-width: 170px;
        max-height: 200px;
        font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    var map = L.map('map', { preferCanvas: true }).setView([39.0, -75.45], 9);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    /* -----------------------------
       Zone list control (collapsible)
    ----------------------------- */
    var zoneControl = L.control({ position: 'topright' });

    zoneControl.onAdd = function () {
      var div = L.DomUtil.create('div', 'zone-control');
      div.innerHTML =
        '<div class="title">' +
          '<span>Clamming Zones and Sites</span>' +
          '<div class="btns">' +
            '<button id="togglePanelBtn" type="button">Hide</button>' +
            '<button id="showAllBtn" type="button">Show all</button>' +
          '</div>' +
        '</div>' +
        '<div class="hint">Click a zone to zoom in. Click a point or polygon for site details.</div>' +
        '<ol id="zoneList"></ol>';

      L.DomEvent.disableClickPropagation(div);
      L.DomEvent.disableScrollPropagation(div);
      return div;
    };

    zoneControl.addTo(map);

    /* Toggle panel */
    setTimeout(function () {
      var panel = document.querySelector('.zone-control');
      var toggleBtn = document.getElementById('togglePanelBtn');

      if (!panel || !toggleBtn) return;

      /* Start collapsed on small screens */
      if (window.innerWidth <= 600) {
        panel.classList.add('collapsed');
        toggleBtn.textContent = 'Show';
      }

      toggleBtn.addEventListener('click', function () {
        panel.classList.toggle('collapsed');
        toggleBtn.textContent =
          panel.classList.contains('collapsed') ? 'Show' : 'Hide';
      });
    }, 0);

    function setActiveZoneInList(zoneName) {
      document.querySelectorAll('.zone-link').forEach(function (el) {
        el.classList.toggle('active', el.dataset.zone === zoneName);
      });
    }

    function clearActiveZoneInList() {
      document.querySelectorAll('.zone-link').forEach(function (el) {
        el.classList.remove('active');
      });
    }

    function polygonDefaultStyle() {
      return { color: "#1f78b4", weight: 2, fillOpacity: 0.4 };
    }
    function polygonHighlightStyle() {
      return { color: "#ff7f00", weight: 4, fillOpacity: 0.35 };
    }
    function pointDefaultStyle() {
      return { radius: 10, fillColor: "#e31a1c", color: "#fff", weight: 2, fillOpacity: 1 };
    }
    function pointHighlightStyle() {
      return { radius: 12, fillColor: "#ff7f00", color: "#fff", weight: 2, fillOpacity: 1 };
    }

    fetch("data/clamming_polygons.geojson")
      .then(r => r.json())
      .then(data => {

        var polygonLayersByZone = new Map();
        var pointLayersByZone = new Map();
        var allBounds = null;

        function addToMapList(mapObj, key, layer) {
          if (!mapObj.has(key)) mapObj.set(key, []);
          mapObj.get(key).push(layer);
        }

        L.geoJSON(data, {
          style: function (feature) {
            if (feature.geometry.type.includes("Polygon")) {
              return polygonDefaultStyle();
            }
          },
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, pointDefaultStyle());
          },
          onEachFeature: function (feature, layer) {
            var p = feature.properties || {};
            var zone = p.zone_name || "Unknown";

            try {
              if (layer.getBounds) {
                allBounds = allBounds ? allBounds.extend(layer.getBounds()) : layer.getBounds();
              } else if (layer.getLatLng) {
                var ll = layer.getLatLng();
                allBounds = allBounds ? allBounds.extend(ll) : L.latLngBounds([ll, ll]);
              }
            } catch (e) {}

            if (feature.geometry.type.includes("Polygon")) {
              addToMapList(polygonLayersByZone, zone, layer);
            }

            if (feature.geometry.type === "Point") {
              addToMapList(pointLayersByZone, zone, layer);
            }

            layer.bindPopup(
              "<b>" + (p.zone_name || "") + "</b><br>" +
              "Site: " + (p.site_name || "")
            );
          }
        }).addTo(map);

        var zoneSet = new Set([
          ...polygonLayersByZone.keys(),
          ...pointLayersByZone.keys()
        ]);

        var zonesSorted = Array.from(zoneSet).sort();

        var listEl = document.getElementById('zoneList');
        listEl.innerHTML = zonesSorted.map(z =>
          '<li><span class="zone-link" data-zone="' + z + '">' + z + '</span></li>'
        ).join('');

        function resetAllStyles() {
          polygonLayersByZone.forEach(layers => layers.forEach(l => l.setStyle(polygonDefaultStyle())));
          pointLayersByZone.forEach(layers => layers.forEach(l => l.setStyle(pointDefaultStyle())));
        }

        function focusZone(zoneName) {
          resetAllStyles();
          setActiveZoneInList(zoneName);

          var bounds = null;

          (polygonLayersByZone.get(zoneName) || []).forEach(l => {
            l.setStyle(polygonHighlightStyle());
            bounds = bounds ? bounds.extend(l.getBounds()) : l.getBounds();
          });

          (pointLayersByZone.get(zoneName) || []).forEach(l => {
            l.setStyle(pointHighlightStyle());
            var ll = l.getLatLng();
            bounds = bounds ? bounds.extend(ll) : L.latLngBounds([ll, ll]);
          });

          if (bounds) map.fitBounds(bounds.pad(0.15));
        }

        listEl.addEventListener('click', function (e) {
          if (e.target.classList.contains('zone-link')) {
            focusZone(e.target.dataset.zone);
          }
        });

        document.getElementById('showAllBtn').addEventListener('click', function () {
          resetAllStyles();
          clearActiveZoneInList();
          if (allBounds) map.fitBounds(allBounds.pad(0.1));
        });

        if (allBounds) map.fitBounds(allBounds.pad(0.1));
      });
  </script>
</body>
</html>
